<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go标准包(三十三):jsoniter - 小山的博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="小山的博客" /><meta name="description" content="1. 介绍 json-iterator是一款快且灵活的JSON解析器,不但100%兼容标准库encoding/json,而且比其更快。虽然官网说比" /><meta name="keywords" content="博客, 小山的博客, hugo" />






<meta name="generator" content="Hugo 0.90.1 with theme even" />


<link rel="canonical" href="https://shershon1991.github.io/post/godoc/%E6%A0%87%E5%87%86%E5%8C%85/33-jsoniter/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b874a8796a492f0d7c86bb24c33cbf052935783a5778ebaf819a8e514bf49f10.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Go标准包(三十三):jsoniter" />
<meta property="og:description" content="1. 介绍 json-iterator是一款快且灵活的JSON解析器,不但100%兼容标准库encoding/json,而且比其更快。虽然官网说比" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shershon1991.github.io/post/godoc/%E6%A0%87%E5%87%86%E5%8C%85/33-jsoniter/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-05-03T00:00:00+00:00" />

<meta itemprop="name" content="Go标准包(三十三):jsoniter">
<meta itemprop="description" content="1. 介绍 json-iterator是一款快且灵活的JSON解析器,不但100%兼容标准库encoding/json,而且比其更快。虽然官网说比"><meta itemprop="datePublished" content="2021-05-03T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-05-03T00:00:00+00:00" />
<meta itemprop="wordCount" content="3540">
<meta itemprop="keywords" content="Go标准包," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go标准包(三十三):jsoniter"/>
<meta name="twitter:description" content="1. 介绍 json-iterator是一款快且灵活的JSON解析器,不但100%兼容标准库encoding/json,而且比其更快。虽然官网说比"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">小山的博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">小山的博客</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go标准包(三十三):jsoniter</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-05-03 </span>
        <div class="post-category">
            <a href="/categories/%E7%BC%96%E7%A8%8B/"> 编程 </a>
            <a href="/categories/go/"> Go </a>
            </div>
          <span class="more-meta"> 3540 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-介绍">1. 介绍</a>
          <ul>
            <li><a href="#11-官网性能对比图">1.1 官网性能对比图</a></li>
            <li><a href="#12-自写程序验证">1.2 自写程序验证</a></li>
            <li><a href="#13-为什么比encodingjson快">1.3 为什么比<code>encoding/json</code>快？</a></li>
          </ul>
        </li>
        <li><a href="#2-下载">2. 下载</a></li>
        <li><a href="#3-使用">3. 使用</a>
          <ul>
            <li><a href="#31-完全兼容encodingjson">3.1 完全兼容<code>encoding/json</code></a></li>
            <li><a href="#32-序列化成string">3.2 序列化成<code>string</code></a></li>
            <li><a href="#33-序列化成byte">3.3 序列化成<code>[]byte</code></a></li>
            <li><a href="#34-反序列化">3.4 反序列化</a></li>
            <li><a href="#35-类型不匹配场景">3.5 类型不匹配场景</a></li>
            <li><a href="#36-处理私有属性">3.6 处理私有属性</a></li>
            <li><a href="#37-时间类型处理">3.7 时间类型处理</a></li>
            <li><a href="#38-直接读取json字符串">3.8 直接读取<code>Json</code>字符串</a></li>
            <li><a href="#39-大驼峰转下划线">3.9 大驼峰转下划线</a></li>
          </ul>
        </li>
        <li><a href="#4-避坑concurrent-map-writes">4. 避坑:<code>concurrent map writes</code></a>
          <ul>
            <li><a href="#41-错误使用">4.1 错误使用</a></li>
            <li><a href="#42-正确使用">4.2 正确使用</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>[NOTE] Updated <span class="timeago" datetime="2021-05-03T00:00:00" title="May 3, 2021">May 3, 2021</span>. This article may have outdated content or subject matter.</p>
    </div>
  </div>
    <div class="post-content">
      <h2 id="1-介绍">1. 介绍</h2>
<p><code>json-iterator</code>是一款快且灵活的<code>JSON</code>解析器,不但<code>100%</code>兼容标准库<code>encoding/json</code>,而且比其更快。虽然官网说比标准包<code>encoding/json</code>快6倍之多，但是随着<code>Go</code>版本的不断迭代，目前平均比<code>encoding/json</code>快2倍。</p>
<p>官网给出的性能对比结果如下:</p>
<h3 id="11-官网性能对比图">1.1 官网性能对比图</h3>
<p><img src="https://gitee.com/tangxiaoshan/pic-img-bed/raw/master/go/img/687474703a2f2f6a736f6e697465722e636f6d2f62656e63686d61726b732f676f2d62656e63686d61726b2e706e67.png" alt="性能图"></p>
<h3 id="12-自写程序验证">1.2 自写程序验证</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">➜</span>  <span class="k">go</span><span class="o">-</span><span class="nx">study</span><span class="o">-</span><span class="nx">example</span> <span class="nx">git</span><span class="p">:(</span><span class="nx">main</span><span class="p">)</span> <span class="err">✗</span> <span class="k">go</span> <span class="nx">test</span> <span class="o">-</span><span class="nx">bench</span><span class="p">=.</span> <span class="nx">test</span><span class="o">/</span><span class="nx">jsoniter_test</span><span class="p">.</span><span class="k">go</span> <span class="o">-</span><span class="nx">benchmem</span>
<span class="nx">goos</span><span class="p">:</span> <span class="nx">darwin</span>
<span class="nx">goarch</span><span class="p">:</span> <span class="nx">amd64</span>
<span class="nx">cpu</span><span class="p">:</span> <span class="nf">Intel</span><span class="p">(</span><span class="nx">R</span><span class="p">)</span> <span class="nf">Core</span><span class="p">(</span><span class="nx">TM</span><span class="p">)</span> <span class="nx">i7</span><span class="o">-</span><span class="mi">8750</span><span class="nx">H</span> <span class="nx">CPU</span> <span class="err">@</span> <span class="mf">2.20</span><span class="nx">GHz</span>
<span class="nx">BenchmarkUnMarshalIter</span><span class="o">-</span><span class="mi">12</span>         <span class="mi">559245</span>              <span class="mi">2126</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>            <span class="mi">1240</span> <span class="nx">B</span><span class="o">/</span><span class="nx">op</span>         <span class="mi">39</span> <span class="nx">allocs</span><span class="o">/</span><span class="nx">op</span>
<span class="nx">BenchmarkUnMarshalJson</span><span class="o">-</span><span class="mi">12</span>         <span class="mi">218618</span>              <span class="mi">5390</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>            <span class="mi">1448</span> <span class="nx">B</span><span class="o">/</span><span class="nx">op</span>         <span class="mi">33</span> <span class="nx">allocs</span><span class="o">/</span><span class="nx">op</span>
<span class="nx">BenchmarkMarshalIter</span><span class="o">-</span><span class="mi">12</span>           <span class="mi">629608</span>              <span class="mi">1988</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>            <span class="mi">1121</span> <span class="nx">B</span><span class="o">/</span><span class="nx">op</span>         <span class="mi">11</span> <span class="nx">allocs</span><span class="o">/</span><span class="nx">op</span>
<span class="nx">BenchmarkMarshal</span><span class="o">-</span><span class="mi">12</span>               <span class="mi">528918</span>              <span class="mi">2295</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>            <span class="mi">1272</span> <span class="nx">B</span><span class="o">/</span><span class="nx">op</span>         <span class="mi">15</span> <span class="nx">allocs</span><span class="o">/</span><span class="nx">op</span>
<span class="nx">PASS</span>
<span class="nx">ok</span>      <span class="nx">command</span><span class="o">-</span><span class="nx">line</span><span class="o">-</span><span class="nx">arguments</span>  <span class="mf">6.027</span><span class="nx">s</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong><font color=red>经多次运行，发现反序列化(<code>Unmarshal</code>)比标准包快了2.5倍,而序列化(<code>Marshal</code>)基本没有什么很高的性能提升。</font></strong></p>
</blockquote>
<h3 id="13-为什么比encodingjson快">1.3 为什么比<code>encoding/json</code>快？</h3>
<p><code>jsoniter</code> 能够比<code>encoding/json</code>快的主要原因，</p>
<ul>
<li>减少不必要的内存复制。</li>
<li>减少 反射(<code>reflect</code>） 的使用，对同一类型的对象，<code>jsoniter </code>只反射一次之后即缓存下来。</li>
</ul>
<h2 id="2-下载">2. 下载</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">get</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">json</span><span class="o">-</span><span class="nx">iterator</span><span class="o">/</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="3-使用">3. 使用</h2>
<h3 id="31-完全兼容encodingjson">3.1 完全兼容<code>encoding/json</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">json</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nx">ConfigCompatibleWithStandardLibrary</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="32-序列化成string">3.2 序列化成<code>string</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 序列化成字符串
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestMarshalToString</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">order</span> <span class="o">:=</span> <span class="nx">Order</span><span class="p">{</span>
		<span class="nx">Id</span><span class="p">:</span>       <span class="mi">10</span><span class="p">,</span>
		<span class="nx">OrderNum</span><span class="p">:</span> <span class="s">&#34;100200300&#34;</span><span class="p">,</span>
		<span class="nx">Money</span><span class="p">:</span>    <span class="mf">99.99</span><span class="p">,</span>
		<span class="nx">PayTime</span><span class="p">:</span>  <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
		<span class="nx">Extend</span><span class="p">:</span>   <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;张三&#34;</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="c1">// 直接转成字符串
</span><span class="c1"></span>	<span class="nx">jsonStr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">MarshalToString</span><span class="p">(</span><span class="nx">order</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;jsonStr:&#34;</span><span class="p">,</span> <span class="nx">jsonStr</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestMarshalToString
</span><span class="cm">jsonStr: {&#34;id&#34;:10,&#34;orderNum&#34;:&#34;100200300&#34;,&#34;money&#34;:99.99,&#34;payTime&#34;:&#34;2021-12-28T23:44:36.258311+08:00&#34;,&#34;extend&#34;:{&#34;name&#34;:&#34;张三&#34;}}
</span><span class="cm">--- PASS: TestMarshalToString (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="33-序列化成byte">3.3 序列化成<code>[]byte</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 序列化成[]byte
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestMarshalToByte</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">order</span> <span class="o">:=</span> <span class="nx">Order</span><span class="p">{</span>
		<span class="nx">Id</span><span class="p">:</span>       <span class="mi">10</span><span class="p">,</span>
		<span class="nx">OrderNum</span><span class="p">:</span> <span class="s">&#34;100200300&#34;</span><span class="p">,</span>
		<span class="nx">Money</span><span class="p">:</span>    <span class="mf">99.99</span><span class="p">,</span>
		<span class="nx">PayTime</span><span class="p">:</span>  <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
		<span class="nx">Extend</span><span class="p">:</span>   <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;张三&#34;</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="c1">// 转成字节[]byte
</span><span class="c1"></span>	<span class="nx">marshal</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">order</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;marshal:&#34;</span><span class="p">,</span> <span class="nx">marshal</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestMarshalToByte
</span><span class="cm">marshal: [123 34 105 100 34 58 49 48 44 34 111 114 100 101 114 78 117 109 34 58 34 49 48 48 50 48 48 51 48 48 34 44 34 109 111 110 101 121 34 58 57 57 46 57 57 44 34 112 97 121 84 105 109 101 34 58 34 50 48 50 49 45 49 50 45 50 56 84 50 51 58 52 54 58 49 51 46 49 48 53 52 54 54 43 48 56 58 48 48 34 44 34 101 120 116 101 110 100 34 58 123 34 110 97 109 101 34 58 34 229 188 160 228 184 137 34 125 125]
</span><span class="cm">--- PASS: TestMarshalToByte (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="34-反序列化">3.4 反序列化</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 反序列化
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestUnmarshalTmp</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">str</span> <span class="o">:=</span> <span class="s">`{&#34;id&#34;:10,&#34;orderNum&#34;:&#34;100200300&#34;,&#34;money&#34;:99.99,&#34;payTime&#34;:&#34;2021-12-28T23:44:36.258311+08:00&#34;,&#34;extend&#34;:{&#34;name&#34;:&#34;张三&#34;}}`</span>
	<span class="kd">var</span> <span class="nx">order</span> <span class="nx">Order</span>
	<span class="c1">// 从字符串反序列化
</span><span class="c1"></span>	<span class="nx">_</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">UnmarshalFromString</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">order</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;order:&#34;</span><span class="p">,</span> <span class="nx">order</span><span class="p">)</span>

	<span class="kd">var</span> <span class="nx">order2</span> <span class="nx">Order</span>
	<span class="c1">// 从[]byte反序列化
</span><span class="c1"></span>	<span class="nx">_</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">order2</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;order2:&#34;</span><span class="p">,</span> <span class="nx">order2</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestUnmarshalTmp
</span><span class="cm">order: {10 100200300 99.99 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]}
</span><span class="cm">order2: {10 100200300 99.99 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]}
</span><span class="cm">--- PASS: TestUnmarshalTmp (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="35-类型不匹配场景">3.5 类型不匹配场景</h3>
<h4 id="1-结构体定义">1. 结构体定义</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Order</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Id</span>       <span class="kt">int</span>               <span class="s">`json:&#34;id,omitempty&#34;`</span>
	<span class="nx">OrderNum</span> <span class="kt">string</span>            <span class="s">`json:&#34;orderNum,omitempty&#34;`</span>
	<span class="nx">Money</span>    <span class="kt">float64</span>           <span class="s">`json:&#34;money,omitempty&#34;`</span>
	<span class="nx">PayTime</span>  <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>         <span class="s">`json:&#34;payTime&#34;`</span>
	<span class="nx">Extend</span>   <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`json:&#34;extend&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="2-encodingjson">2. <code>encoding/json</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 使用encoding/json反序列化
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestTypeCovert</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// money 为float64类型，故意设置成字符串
</span><span class="c1"></span>	<span class="nx">str</span> <span class="o">:=</span> <span class="s">`{&#34;id&#34;:10,&#34;orderNum&#34;:&#34;100200300&#34;,&#34;money&#34;:&#34;99.99&#34;,&#34;payTime&#34;:&#34;2021-12-28T23:44:36.258311+08:00&#34;,&#34;extend&#34;:{&#34;name&#34;:&#34;张三&#34;}}`</span>
	<span class="kd">var</span> <span class="nx">order</span> <span class="nx">Order</span>
	<span class="c1">// 使用标准库解析
</span><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">order</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;json err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;order: &#34;</span><span class="p">,</span> <span class="nx">order</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestTypeCovert
</span><span class="cm">json err: json: cannot unmarshal string into Go struct field Order.money of type float64
</span><span class="cm">order:  {10 100200300 0 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]}
</span><span class="cm">--- PASS: TestTypeCovert (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="3-json-iterator">3. <code>json-iterator</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 使用json-iterator反序列化
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestTypeCovertWithJsonIter</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// money 为float64类型，故意设置成字符串
</span><span class="c1"></span>	<span class="nx">str</span> <span class="o">:=</span> <span class="s">`{&#34;id&#34;:10,&#34;orderNum&#34;:&#34;100200300&#34;,&#34;money&#34;:&#34;99.99&#34;,&#34;payTime&#34;:&#34;2021-12-28T23:44:36.258311+08:00&#34;,&#34;extend&#34;:{&#34;name&#34;:&#34;张三&#34;}}`</span>
	<span class="kd">var</span> <span class="nx">order</span> <span class="nx">Order</span>
	<span class="c1">// 定义
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">jsonNew</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nx">ConfigCompatibleWithStandardLibrary</span>
	<span class="c1">// 自适应类型
</span><span class="c1"></span>	<span class="nx">extra</span><span class="p">.</span><span class="nf">RegisterFuzzyDecoders</span><span class="p">()</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">jsonNew</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">order</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;jsonNew err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;order: &#34;</span><span class="p">,</span> <span class="nx">order</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestTypeCovertWithJsonIter
</span><span class="cm">order:  {10 100200300 99.99 2021-12-28 23:44:36.258311 +0800 CST map[name:张三]}
</span><span class="cm">--- PASS: TestTypeCovertWithJsonIter (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="36-处理私有属性">3.6 处理私有属性</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 定义结构体，里面包含私有属性
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Demo</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">FirstName</span> <span class="kt">string</span> <span class="s">`json:&#34;firstName,omitempty&#34;`</span>
	<span class="nx">lastName</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// 解析私有属性
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestDealPrivate</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">d</span> <span class="o">:=</span> <span class="nx">Demo</span><span class="p">{</span>
		<span class="nx">FirstName</span><span class="p">:</span> <span class="s">&#34;张&#34;</span><span class="p">,</span>
		<span class="nx">lastName</span><span class="p">:</span>  <span class="s">&#34;三丰&#34;</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="c1">// 开启解析私有属性，注：私有属性不能有json标签，否则不能解析
</span><span class="c1"></span>	<span class="nx">extra</span><span class="p">.</span><span class="nf">SupportPrivateFields</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">jsonNew</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nx">ConfigCompatibleWithStandardLibrary</span>
	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">jsonNew</span><span class="p">.</span><span class="nf">MarshalToString</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;序列化-err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;序列化-res:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
	<span class="c1">// 反序列化私有属性
</span><span class="c1"></span>	<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="s">`{&#34;firstName&#34;:&#34;张&#34;,&#34;lastName&#34;:&#34;三丰&#34;}`</span>
	<span class="kd">var</span> <span class="nx">d2</span> <span class="nx">Demo</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">jsonNew</span><span class="p">.</span><span class="nf">UnmarshalFromString</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">d2</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;反序列化-err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;反序列化-d2:&#34;</span><span class="p">,</span> <span class="nx">d2</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestDealPrivate
</span><span class="cm">序列化-err: &lt;nil&gt;
</span><span class="cm">序列化-res: {&#34;firstName&#34;:&#34;张&#34;,&#34;lastName&#34;:&#34;三丰&#34;}
</span><span class="cm">反序列化-err: &lt;nil&gt;
</span><span class="cm">反序列化-d2: {张 三丰}
</span><span class="cm">--- PASS: TestDealPrivate (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="37-时间类型处理">3.7 时间类型处理</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">timeDemo</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">CreateTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;createTime&#34;`</span>
<span class="p">}</span>
<span class="c1">// 解析时间
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestDealTime</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">td</span> <span class="o">:=</span> <span class="nx">timeDemo</span><span class="p">{</span><span class="nx">CreateTime</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}</span>
	<span class="kd">var</span> <span class="nx">jsonNew</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nx">ConfigCompatibleWithStandardLibrary</span>
	<span class="c1">// 转成以秒
</span><span class="c1"></span>	<span class="nx">extra</span><span class="p">.</span><span class="nf">RegisterTimeAsInt64Codec</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="c1">// 序列化
</span><span class="c1"></span>	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">jsonNew</span><span class="p">.</span><span class="nf">MarshalToString</span><span class="p">(</span><span class="nx">td</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;时间序列化-err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;时间序列化-res:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
	<span class="c1">// 反序列化
</span><span class="c1"></span>	<span class="nx">str</span> <span class="o">:=</span> <span class="s">`{&#34;createTime&#34;:1640791445}`</span>
	<span class="kd">var</span> <span class="nx">tds</span> <span class="nx">timeDemo</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">jsonNew</span><span class="p">.</span><span class="nf">UnmarshalFromString</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">tds</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;时间反序列化-err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;时间反序列化-res:&#34;</span><span class="p">,</span> <span class="nx">tds</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">type timeDemo struct {
</span><span class="cm">	CreateTime time.Time `json:&#34;createTime&#34;`
</span><span class="cm">}
</span><span class="cm">// 解析时间
</span><span class="cm">=== RUN   TestDealTime
</span><span class="cm">时间序列化-err: &lt;nil&gt;
</span><span class="cm">时间序列化-res: {&#34;createTime&#34;:1640792397}
</span><span class="cm">时间反序列化-err: &lt;nil&gt;
</span><span class="cm">时间反序列化-res: {2021-12-29 23:24:05 +0800 CST}
</span><span class="cm">--- PASS: TestDealTime (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="38-直接读取json字符串">3.8 直接读取<code>Json</code>字符串</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 直接读取json 字符串
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestReadJsonString</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">str</span> <span class="o">:=</span> <span class="s">`{
</span><span class="s">    &#34;id&#34;:10,
</span><span class="s">    &#34;extend&#34;:{
</span><span class="s">        &#34;name&#34;:&#34;张三&#34;
</span><span class="s">    },
</span><span class="s">    &#34;desc&#34;:[
</span><span class="s">        {
</span><span class="s">            &#34;score&#34;:&#34;100&#34;
</span><span class="s">        },
</span><span class="s">        {
</span><span class="s">            &#34;score&#34;:&#34;90&#34;
</span><span class="s">        }
</span><span class="s">    ]
</span><span class="s">}`</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;id:&#34;</span><span class="p">,</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="s">&#34;id&#34;</span><span class="p">).</span><span class="nf">ToInt</span><span class="p">())</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;extend.name:&#34;</span><span class="p">,</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="s">&#34;extend&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">).</span><span class="nf">ToString</span><span class="p">())</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;desc.0.score:&#34;</span><span class="p">,</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="s">&#34;desc&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;score&#34;</span><span class="p">).</span><span class="nf">ToInt</span><span class="p">())</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;desc.1.score:&#34;</span><span class="p">,</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">Get</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="s">&#34;desc&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;score&#34;</span><span class="p">).</span><span class="nf">ToInt</span><span class="p">())</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestReadJsonString
</span><span class="cm">id: 10
</span><span class="cm">extend.name: 张三
</span><span class="cm">desc.0.score: 100
</span><span class="cm">desc.1.score: 90
</span><span class="cm">--- PASS: TestReadJsonString (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="39-大驼峰转下划线">3.9 大驼峰转下划线</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">PayInfo</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">OrderId</span>  <span class="kt">int</span>
	<span class="nx">PayMoney</span> <span class="kt">float64</span> <span class="s">`json:&#34;payMoney&#34;`</span>
<span class="p">}</span>
<span class="c1">// 没有json标签的大驼峰属性，会转成下划线变量
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestSetNamingStrategy</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">payInfo</span> <span class="o">:=</span> <span class="nx">PayInfo</span><span class="p">{</span>
		<span class="nx">OrderId</span><span class="p">:</span>  <span class="mi">100</span><span class="p">,</span>
		<span class="nx">PayMoney</span><span class="p">:</span> <span class="mf">9.9</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="c1">// -------- 序列化 --------
</span><span class="c1"></span>	<span class="c1">// 设置后，没有json标签的属性，会自动转成 xx_xx
</span><span class="c1"></span>	<span class="nx">extra</span><span class="p">.</span><span class="nf">SetNamingStrategy</span><span class="p">(</span><span class="nx">extra</span><span class="p">.</span><span class="nx">LowerCaseWithUnderscores</span><span class="p">)</span>
	<span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">MarshalToString</span><span class="p">(</span><span class="nx">payInfo</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;序列化:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
	<span class="c1">// -------- 反序列化 --------
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">p</span> <span class="nx">PayInfo</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nf">UnmarshalFromString</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;反序列化:%+v \n&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestSetNamingStrategy
</span><span class="cm">序列化: {&#34;order_id&#34;:100,&#34;payMoney&#34;:9.9}
</span><span class="cm">反序列化:{OrderId:100 PayMoney:9.9} 
</span><span class="cm">--- PASS: TestSetNamingStrategy (0.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><p><strong><font color=blue>@设置<code>SetNamingStrategy</code>后，有<code>json</code>标签的使用<code>json</code>标签，没有的则会自动转成xx_xx</font></strong></p>
<h2 id="4-避坑concurrent-map-writes">4. 避坑:<code>concurrent map writes</code></h2>
<p><strong><font color=red>@设置<code>extra.RegisterFuzzyDecoders()</code>时，注意不要在多个协程中重复设置，在init函数执行一次即可，否则会报错：fatal error: concurrent map writes</font></strong></p>
<h3 id="41-错误使用">4.1 错误使用</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TestUseRegisterFuzzyDecodersWithGoroutine</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">payInfo</span> <span class="o">:=</span> <span class="nx">PayInfo</span><span class="p">{</span>
		<span class="nx">OrderId</span><span class="p">:</span>  <span class="mi">100</span><span class="p">,</span>
		<span class="nx">PayMoney</span><span class="p">:</span> <span class="mf">9.9</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="c1">// 在多个协程中设置extra.RegisterFuzzyDecoders()
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">jsonNew</span> <span class="o">:=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nx">ConfigCompatibleWithStandardLibrary</span>
			<span class="nx">extra</span><span class="p">.</span><span class="nf">RegisterFuzzyDecoders</span><span class="p">()</span>
			<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">jsonNew</span><span class="p">.</span><span class="nf">MarshalToString</span><span class="p">(</span><span class="nx">payInfo</span><span class="p">)</span>
		<span class="p">}()</span>
	<span class="p">}</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ok&#34;</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**报错
</span><span class="cm">=== RUN   TestUseRegisterFuzzyDecodersWithGoroutine
</span><span class="cm">fatal error: concurrent map writes
</span><span class="cm">fatal error: concurrent map writes
</span><span class="cm">fatal error: concurrent map writes
</span><span class="cm">....
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="42-正确使用">4.2 正确使用</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// 在init中设置一次即可
</span><span class="c1"></span>	<span class="nx">extra</span><span class="p">.</span><span class="nf">RegisterFuzzyDecoders</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">TestUseRegisterFuzzyDecodersWithGoroutine</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">payInfo</span> <span class="o">:=</span> <span class="nx">PayInfo</span><span class="p">{</span>
		<span class="nx">OrderId</span><span class="p">:</span>  <span class="mi">100</span><span class="p">,</span>
		<span class="nx">PayMoney</span><span class="p">:</span> <span class="mf">9.9</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="c1">// 在多个协程中设置extra.RegisterFuzzyDecoders()
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">jsonNew</span> <span class="o">:=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nx">ConfigCompatibleWithStandardLibrary</span>
			<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">jsonNew</span><span class="p">.</span><span class="nf">MarshalToString</span><span class="p">(</span><span class="nx">payInfo</span><span class="p">)</span>
		<span class="p">}()</span>
	<span class="p">}</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ok&#34;</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/**输出
</span><span class="cm">=== RUN   TestUseRegisterFuzzyDecodersWithGoroutine
</span><span class="cm">ok
</span><span class="cm">--- PASS: TestUseRegisterFuzzyDecodersWithGoroutine (1.00s)
</span><span class="cm">PASS
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">小山的博客</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2021-05-03
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/go%E6%A0%87%E5%87%86%E5%8C%85/">Go标准包</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/godoc/%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91/1-%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91-%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D%E5%92%8C%E8%B7%AF%E7%94%B1%E8%AE%BE%E8%AE%A1/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">框架开发(一):框架开发-目录介绍和路由设计</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/godoc/%E6%A0%87%E5%87%86%E5%8C%85/32-go-funk/">
            <span class="next-text nav-default">Go标准包(三十二):go-funk</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="https://shershon1991.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>小山的博客</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "en".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
